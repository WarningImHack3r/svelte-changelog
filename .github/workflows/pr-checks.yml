name: Pull Request Checks

on:
  pull_request:
    paths:
      - src/**
      - static/**
      - package.json
      - pnpm-lock.yaml
      - "*.config.*s"
      - tsconfig.json
      - .github/workflows/*

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  permissions-check:
    name: Permissions check
    runs-on: ubuntu-latest
    outputs:
      has-permissions: ${{ steps.check-output.outputs.has-permissions }}

    steps:
      - name: Has access to secrets?
        id: secrets-check
        continue-on-error: true
        uses: actions/checkout@v6
        with:
          repository: ${{ github.event.repository.full_name }}
          ref: ${{ github.head_ref }}
          token: ${{ secrets.WORKFLOW_PAT }}

      - name: ðŸ“¤ Set output
        id: check-output
        if: always()
        run: echo "has-permissions=${{ steps.secrets-check.outcome == 'success' && 'true' || 'false' }}" >> $GITHUB_OUTPUT

  check-and-fix:
    name: Check and fix
    runs-on: ubuntu-latest
    needs: permissions-check
    permissions:
      contents: write

    steps:
      - name: ðŸ“‚ Checkout
        uses: actions/checkout@v6
        with:
          repository: ${{ github.event.repository.full_name }}
          ref: eldest-mink
          token: ${{ needs.permissions-check.outputs.has-permissions == 'false' && github.token || secrets.WORKFLOW_PAT }}
          fetch-depth: ${{ github.event_name == 'push' && 2 || 1 }}

      - name: ðŸ“¥ Install pnpm
        uses: pnpm/action-setup@v4
